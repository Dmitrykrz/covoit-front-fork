<div class="page-wrapper">
  <app-navbar></app-navbar>

  <main class="mes-annonces-container">
    <h1 class="page-title">MES ANNONCES</h1>

    <!-- Filtres -->
    <div class="filters-container">
      <button
        class="filter-btn"
        [class.active]="filterType === 'avenir'"
        (click)="setFilter('avenir')">
        üìÖ √Ä venir ({{ annoncesAvenir.length }})
      </button>
      <button
        class="filter-btn"
        [class.active]="filterType === 'passees'"
        (click)="setFilter('passees')">
        üìú Pass√©es ({{ annoncesPassees.length }})
      </button>
    </div>

    <!-- Message d'erreur -->
    <div *ngIf="errorMessage" class="error-message">
      {{ errorMessage }}
    </div>

    <!-- Loader -->
    <div *ngIf="isLoading" class="loading-spinner">
      <div class="spinner"></div>
      <p>Chargement des annonces...</p>
    </div>

    <!-- Tableau des annonces -->
    <div *ngIf="!isLoading && pagedAnnonces && pagedAnnonces.length > 0" class="annonces-table-container">
      <table class="annonces-table">
        <thead>
        <tr>
          <th>Date de d√©part</th>
          <th>Adresse de d√©part</th>
          <th>Adresse d'arriv√©e</th>
          <th>Marque</th>
          <th>Mod√®le</th>
          <th>Photo</th>
          <th>Participants</th>
          <th>Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let annonce of pagedAnnonces"
            [class.row-passee]="filterType === 'passees'">
          <td>{{ formatHeureDepart(annonce.annonce.heureDepart) }}</td>
          <td>{{ formatAdresse(annonce.annonce.adresseDepart) }}</td>
          <td>{{ formatAdresse(annonce.annonce.adresseArrivee) }}</td>
          <td>{{ annonce.vehicule?.marque || 'Chargement...' }}</td>
          <td>{{ annonce.vehicule?.modele || 'Chargement...' }}</td>
          <td class="photo-cell">
            <img
              *ngIf="annonce.vehicule?.photo"
              [src]="annonce.vehicule?.photo"
              [alt]="(annonce.vehicule?.marque || '') + ' ' + (annonce.vehicule?.modele || '')"
              class="vehicle-photo">
            <span *ngIf="!annonce.vehicule?.photo" class="no-photo">üì∑</span>
          </td>
          <td>{{ getParticipants(annonce) }}</td>
          <td class="actions-cell">
            <button
              class="action-btn info-btn"
              (click)="voirDetails(annonce)"
              title="Voir les d√©tails">
              <i class="icon-info">‚ÑπÔ∏è</i>
            </button>

            <button
              *ngIf="filterType === 'avenir'"
              class="action-btn edit-btn"
              (click)="modifierAnnonce(annonce)"
              [disabled]="!peutEtreModifiee(annonce)"
              [title]="peutEtreModifiee(annonce) ?
                'Modifier' : 'Modification impossible (annonce r√©serv√©e)'">
              <i class="icon-edit">‚úèÔ∏è</i>
            </button>

            <button
              *ngIf="filterType === 'avenir'"
              class="action-btn delete-btn"
              (click)="confirmerSuppression(annonce)"
              title="Supprimer">
              <i class="icon-delete">üóëÔ∏è</i>
            </button>
          </td>
        </tr>
        </tbody>
      </table>

      <div class="pagination">
        <button type="button" class="pager" (click)="prevPage()" [disabled]="currentPage === 1">Pr√©c√©dent</button>
        <span class="pager__info">Page {{ currentPage }} / {{ totalPages }}</span>
        <button type="button" class="pager" (click)="nextPage()" [disabled]="currentPage === totalPages">Suivant</button>
      </div>
    </div>

    <!-- Message si aucune annonce -->
    <div *ngIf="!isLoading && (!pagedAnnonces || pagedAnnonces.length === 0)" class="no-annonces">
      <p *ngIf="filterType === 'avenir'">Vous n'avez pas d'annonce √† venir.</p>
      <p *ngIf="filterType === 'passees'">Vous n'avez pas d'annonce pass√©e.</p>
    </div>

    <!-- Bouton poster une annonce -->
    <div class="action-button-container">
      <button class="btn-poster-annonce" (click)="posterAnnonce()">
        POSTER UNE ANNONCE
      </button>
    </div>
  </main>

  <app-footer></app-footer>
</div>

<!-- Modal de confirmation de suppression -->
<app-delete-confirmation-dialog
  [open]="showDeleteModal"
  [title]="'Confirmer la suppression'"
  [message]="'√ätes-vous s√ªr de vouloir supprimer cette annonce ?'"
  [warningMessage]="'Un email sera envoy√© √† tous les participants qui ont r√©serv√© cette annonce.'"
  [confirmLabel]="'Confirmer'"
  [cancelLabel]="'Annuler'"
  (confirm)="supprimerAnnonce()"
  (cancel)="annulerSuppression()">
</app-delete-confirmation-dialog>

<!-- Modale de d√©tail d'annonce -->
<app-annonce-detail-modal
  [isOpen]="showDetailModal"
  [annonce]="selectedAnnonce"
  [conducteur]="{ prenom: currentUser?.prenom || '', nom: currentUser?.nom || '' }"
  [isPassee]="filterType === 'passees'"
  (close)="closeDetailModal()"
  (annuler)="onAnnulerAnnonce($event)">
</app-annonce-detail-modal>

<!-- Modale de modification d'annonce -->
<app-edit-annonce-modal
  [isOpen]="showEditModal"
  [annonce]="annonceToEdit"
  (close)="closeEditModal()"
  (updated)="onAnnonceUpdated()">
</app-edit-annonce-modal>
