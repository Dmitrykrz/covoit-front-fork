<app-navbar></app-navbar>

<div class="vehicules-page">

  <!-- =========================================================
       SECTION 1 ‚Äî V√âHICULE PERSONNEL
       ========================================================= -->
  <section class="panel" aria-labelledby="title-vehicule-perso">
    <h2 id="title-vehicule-perso" class="panel__title">MON V√âHICULE PERSONNEL</h2>

    @if (vehiculePersoList() != null && vehiculePersoList().length > 0) {
      <div class="card">
        <table class="table table--vehicule">
          <thead>
            <tr>
              <th scope="col">Marque</th>
              <th scope="col">Mod√®le</th>
              <th scope="col">Immatriculation</th>
              <th scope="col">Nombre de places</th>
              <th scope="col">CO‚ÇÇ/km</th>
              <th scope="col">Cat√©gorie</th>
              <th scope="col">Motorisation</th>
              <th scope="col">Photo</th>
              <th scope="col" class="actions-col">Actions</th>
            </tr>
          </thead>

          <tbody>
            @for (vehiculePerso of vehiculePersoList(); track vehiculePerso.id ?? $index) {
              <tr>
                <td>{{ vehiculePerso?.marque || '‚Äî' }}</td>
                <td>{{ vehiculePerso?.modele || '‚Äî' }}</td>
                <td class="immat">{{ vehiculePerso?.immatriculation || '‚Äî' }}</td>
                <td>{{ vehiculePerso?.nbPlaces || '‚Äî' }}</td>
                <td>{{ vehiculePerso?.co2ParKm || '‚Äî' }}</td>
                <td>{{ vehiculePerso?.categorie || '‚Äî' }}</td>
                <td>{{ vehiculePerso?.motorisation || '‚Äî' }}</td>

                <!-- Photo -->
                <td class="photo-cell">
                  <img
                    class="thumb"
                    [src]="vehiculePerso?.photo || 'https://placehold.co/72x48?text=Photo'"
                    alt="Photo v√©hicule"
                    loading="lazy" />
                </td>

                <!-- Actions -->
                <td class="actions-col">
                  <button
                    type="button"
                    class="icon-btn"
                    title="Modifier le v√©hicule"
                    (click)="openEditVehicule(vehiculePerso)">
                    <i class="icon-edit">‚úèÔ∏è</i>
                  </button>

                  <button
                    type="button"
                    class="icon-btn"
                    title="Supprimer le v√©hicule"
                    (click)="openSuppression(vehiculePerso)">
                    <i class="icon-delete">üóëÔ∏è</i>
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @else {
      <!-- √âtat vide -->
      <div class="card empty-personal">
        <p>Vous n‚Äôavez pas encore de v√©hicule personnel.</p>
        <div class="cta">
          <button type="button" class="btn-primary" (click)="openCreationVehicule()">
            D√©clarer mon v√©hicule personnel
          </button>
        </div>
      </div>
    }
  </section>


  <!-- =========================================================
       SECTION 2 ‚Äî R√âSERVATIONS DE V√âHICULES DE SOCI√âT√â
       ========================================================= -->
  <section class="panel" aria-labelledby="title-reservations">
    <h2 id="title-reservations" class="panel__title">MES R√âSERVATIONS DE V√âHICULES DE SOCI√âT√â</h2>

    <div class="card">
      <table class="table table--reservations">
        <thead>
          <tr>
            <th scope="col">Marque</th>
            <th scope="col">Mod√®le</th>
            <th scope="col">Immatriculation</th>
            <th scope="col">Nombre de places</th>
            <th scope="col">CO‚ÇÇ/km</th>
            <th scope="col">Cat√©gorie</th>
            <th scope="col">Motorisation</th>
            <th scope="col">Photo</th>
            <th scope="col">Date de d√©but</th>
            <th scope="col">Date de fin</th>
            <th scope="col" class="actions-col">Actions</th>
          </tr>
        </thead>

        <tbody>
          @for (row of pagedReservations(); track row.id ?? $index) {
            <tr
              [class.row--current]="isCurrent(row)"
              [class.row--past]="isPast(row)">

              <!-- D√©tails v√©hicule -->
              <td>{{ row.vehicule?.marque ?? '‚Äî' }}</td>
              <td>{{ row.vehicule?.modele ?? '‚Äî' }}</td>
              <td class="immat">{{ row.vehicule?.immatriculation ?? '‚Äî' }}</td>
              <td>{{ row.vehicule?.nbPlaces ?? '‚Äî' }}</td>
              <td>{{ row.vehicule?.co2ParKm ?? '‚Äî' }}</td>
              <td>{{ row.vehicule?.categorie ?? '‚Äî' }}</td>
              <td>{{ row.vehicule?.motorisation ?? '‚Äî' }}</td>

              <!-- Photo -->
              <td class="photo-cell">
                <img
                  class="thumb"
                  [src]="row.vehicule?.photo || 'https://placehold.co/72x48?text=Photo'"
                  alt="Photo v√©hicule"
                  loading="lazy" />
              </td>

              <!-- Dates -->
              <td>
                <time [attr.datetime]="row.dateDebut">
                  {{ row.dateDebut | date:'dd/MM/yyyy HH:mm' }}
                </time>
              </td>
              <td>
                <time [attr.datetime]="row.dateFin">
                  {{ row.dateFin | date:'dd/MM/yyyy HH:mm' }}
                </time>
              </td>

              <!-- Actions selon l‚Äô√©tat -->
              <td class="actions-col">
                @if (isUpcoming(row)) {
                  <!-- R√©servation √† venir : annuler -->
                  <button
                    type="button"
                    class="icon-btn"
                    title="Annuler la r√©servation"
                    (click)="openAnnulation(row)">
                    <i class="icon-delete">üóëÔ∏è</i>
                  </button>

                } @else if (isCurrent(row)) {
                  <!-- R√©servation en cours : terminer -->
                  <button
                    type="button"
                    class="icon-btn"
                    title="Terminer la r√©servation"
                    (click)="openFinalisation(row)">
                    <i class="icon-delete">üóëÔ∏è</i>
                  </button>

                } @else {
                  <!-- R√©servation pass√©e : pas d‚Äôaction -->
                }
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="11" class="empty">Aucune r√©servation.</td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      <div class="pagination" role="navigation" aria-label="Pagination des r√©servations">
        <button type="button" class="pager" (click)="prevPage()" [disabled]="page() === 1">
          Pr√©c√©dent
        </button>

        <span class="pager__info">
          Page {{ page() }} / {{ totalPages() }}
        </span>

        <button type="button" class="pager" (click)="nextPage()" [disabled]="page() === totalPages()">
          Suivant
        </button>
      </div>
    </div>
  </section>

  <!-- CTA global -->
  <div class="cta">
    <button type="button" class="btn-primary" (click)="goToReservation()">
      R√âSERVER UN V√âHICULE DE SOCI√âT√â
    </button>
  </div>
</div>


<!-- =========================================================
     MODALES
     ========================================================= -->

<!-- Modale de confirmation (suppression / finalisation) -->
<app-confirm-dialog
  [open]="!!reservationToDelete() || !!reservationToEdit() || !!vehiculePersoToDelete()"
  [title]="modaleTitle()"
  [message]="deleteContent()"
  confirmLabel="Supprimer"
  cancelLabel="Annuler"
  (confirm)="confirmModale()"
  (cancel)="closeModale()">
</app-confirm-dialog>

<!-- Modale suppression impossible -->
<app-information-modale
  [open]="cantDeleteInfoOpen()"
  [title]="cantDeleteInfoTitle()"
  [message]="cantDeleteInfoMessage()"
  closeLabel="Fermer"
  (close)="closeInfoModale()">
</app-information-modale>

<!-- Modale d‚Äô√©dition v√©hicule (modification) -->
@if (vehiculeToEdit(); as editing) {
  <app-vehicule-edit
    [open]="!!vehiculeToEdit()"
    [model]="editing"
    [title]="modaleTitle()"
    [successMessage]="vehiculeSuccessMessage()"
    [errorMessage]="vehiculeErrorMessage()"
    (confirm)="onSaveEdit($event)"
    (cancel)="closeEdit()">
  </app-vehicule-edit>
}

<!-- Modale d‚Äô√©dition v√©hicule (cr√©ation) -->
@if (creationVehicule()) {
  <app-vehicule-edit
    [open]="!!creationVehicule()"
    [title]="modaleTitle()"
    [successMessage]="vehiculeSuccessMessage()"
    [errorMessage]="vehiculeErrorMessage()"
    (confirm)="onSaveEdit($event)"
    (cancel)="closeEdit()">
  </app-vehicule-edit>
}

<app-footer></app-footer>
