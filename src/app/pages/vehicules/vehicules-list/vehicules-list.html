<app-navbar></app-navbar>

<div class="vehicules-page">

  <!-- MON VEHICULE PERSONNEL -->
  <section class="panel">
    <h2 class="panel__title">MON VÉHICULE PERSONNEL</h2>

    @if(vehiculePersoList() != null && vehiculePersoList().length > 0) {
    <div class="card">
      <table class="table table--vehicule">
        <thead>
          <tr>
            <th>Marque</th>
            <th>Modèle</th>
            <th>Immatriculation</th>
            <th>Nombre de places</th>
            <th>CO2/km</th>
            <th>Motorisation</th>
            <th>Photo</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for(vehiculePerso of vehiculePersoList(); track vehiculePerso.id ?? $index) {
          <tr>
            <td>{{ vehiculePerso?.marque || '—' }}</td>
            <td>{{ vehiculePerso?.modele || '—' }}</td>
            <td class="immat">{{ vehiculePerso?.immatriculation || '—' }}</td>
            <td>{{ vehiculePerso?.nbPlaces || '—' }}</td>
            <td>{{ vehiculePerso?.co2ParKm || '—' }}</td>
            <td>{{ vehiculePerso?.motorisation || '—' }}</td>
            <td class="photo-cell">
              <img [src]="vehiculePerso?.photo || 'https://placehold.co/72x48?text=Photo'" alt="Photo véhicule"
                class="thumb" loading="lazy" />
            </td>
            <td class="actions-col">
              <button type="button" class="icon-btn" title="modifier" (click)="openEditVehicule(vehiculePerso)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path
                    d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1 1 0 0 0 0-1.41l-2.34-2.34a1 1 0 0 0-1.41 0L15.13 4.1l3.75 3.75 1.83-1.83z" />
                </svg>
              </button>
              <button type="button" class="icon-btn" title="Supprimer" (click)="openSuppression(vehiculePerso)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9z" />
                </svg>
              </button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    } @else {
    <div class="card empty-personal">
      <p>Vous n’avez pas encore de véhicule personnel.</p>
      <div class="cta">
        <button type="button" class="btn-primary" (click)="openCreationVehicule()">
          Ajouter mon véhicule
        </button>
      </div>
    </div>
    }
  </section>


  <!-- MES RÉSERVATIONS DE VÉHICULES DE SOCIÉTÉ -->
  <section class="panel">
    <h2 class="panel__title">MES RÉSERVATIONS DE VÉHICULES DE SOCIÉTÉ</h2>

    <div class="card">
      <table class="table table--reservations">
        <thead>
          <tr>
            <th>Marque</th>
            <th>Modèle</th>
            <th>Immatriculation</th>
            <th>Nombre de places</th>
            <th>CO2/km</th>
            <th>Motorisation</th>
            <th>Photo</th>
            <th>Date de début</th>
            <th>Date de fin</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for(row of pagedReservations(); track row.id ?? $index){
          <tr [class.row--current]="isCurrent(row)" [class.row--past]="isPast(row)">
            <td>{{ row.vehicule?.marque ?? '—' }}</td>
            <td>{{ row.vehicule?.modele ?? '—' }}</td>
            <td class="immat">{{ row.vehicule?.immatriculation ?? '—' }}</td>
            <td>{{ row.vehicule?.nbPlaces ?? '—' }}</td>
            <td>{{ row.vehicule?.co2ParKm ?? '—' }}</td>
            <td>{{ row.vehicule?.motorisation ?? '—' }}</td>
            <td class="photo-cell">
              <img [src]="row.vehicule?.photo || 'https://placehold.co/72x48?text=Photo'" alt="Photo véhicule"
                class="thumb" loading="lazy" />
            </td>
            <td>
              <time [attr.datetime]="row.dateDebut">{{ row.dateDebut | date:'dd/MM/yyyy HH:mm' }}</time>
            </td>
            <td>
              <time [attr.datetime]="row.dateFin">{{ row.dateFin | date:'dd/MM/yyyy HH:mm' }}</time>
            </td>
            <td class="actions-col">
              @if (isUpcoming(row)) {
              <!-- réservations à venir : annuler -->
              
              <button type="button" class="icon-btn" title="Annuler la réservation" (click)="openAnnulation(row)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9z" />
                </svg>
              </button>
              } @else if (isCurrent(row)) {
              <!-- réservation en cours : terminer -->
              <button type="button" class="icon-btn" title="Terminer la réservation" (click)="openFinalisation(row)">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM7 9h2v9H7V9z" />
                </svg>
              </button>
              } @else {
              <!-- réservations passées : aucune action -->
              }
            </td>
          </tr>
          } @empty {
          <tr>
            <td colspan="10" class="empty">Aucune réservation.</td>
          </tr>
          }
        </tbody>
      </table>
      <div class="pagination">
        <button type="button" class="pager" (click)="prevPage()" [disabled]="page() === 1">Précédent</button>
        <span class="pager__info">Page {{ page() }} / {{ totalPages() }}</span>
        <button type="button" class="pager" (click)="nextPage()" [disabled]="page() === totalPages()">Suivant</button>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <div class="cta">
    <button type="button" class="btn-primary" (click)="goToReservation()">RÉSERVER UN VÉHICULE</button>
  </div>

</div>

<app-confirm-dialog [open]="!!reservationToDelete() || !!reservationToEdit() || !!vehiculePersoToDelete()" [title]="modaleTitle()"
  [message]="deleteContent()" confirmLabel="Supprimer" cancelLabel="Annuler" (confirm)="confirmModale()"
  (cancel)="closeModale()"></app-confirm-dialog>

@if(vehiculeToEdit(); as editing) {
<app-vehicule-edit [open]="!!vehiculeToEdit()" [model]="editing" [title]="modaleTitle()" (confirm)="onSaveEdit($event)"
  (cancel)="closeEdit()"></app-vehicule-edit>
}
@if(creationVehicule()) {
<app-vehicule-edit [open]="!!creationVehicule()" [title]="modaleTitle()" (confirm)="onSaveEdit($event)"
  (cancel)="closeEdit()"></app-vehicule-edit>
}

<app-footer></app-footer>