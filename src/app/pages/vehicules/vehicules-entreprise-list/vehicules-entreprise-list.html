<app-navbar></app-navbar>

<div class="vehicules-page">
  <!-- =========================================================
       SECTION : Liste des v√©hicules d'entreprise
     ========================================================= -->
  <section class="panel">
    <h2 class="panel__title">V√âHICULES D'ENTREPRISE</h2>

    <!-- ========== Barre de filtre ========== -->
    <div class="filters">
      <label class="filter">
        <span>Statut&nbsp;:</span>

        <select [ngModel]="selected()" (ngModelChange)="selected.set($event)">
          <option [ngValue]="'ALL'">Tous</option>
          @for (statut of STATUTS; track $index) {
            <option [ngValue]="statut">
              {{ statut.replace('_',' ').toLowerCase() | titlecase }}
            </option>
          }
        </select>

        <button type="button" class="link-reset" (click)="resetFilter()">
          r√©initialiser
        </button>
      </label>
    </div>

    <!-- ========== Tableau ========== -->
    <div class="card">
      <table class="table table--entreprise">
        <!-- ---- En-t√™te ---- -->
        <thead>
          <tr>
            <th>Marque</th>
            <th>Mod√®le</th>
            <th>Immatriculation</th>
            <th>Nombre de places</th>
            <th>CO‚ÇÇ/km</th>
            <th>Motorisation</th>
            <th>Photo</th>
            <th class="actions-col">Actions</th>
            <th>Statut</th>
          </tr>
        </thead>

        <!-- ---- Corps ---- -->
        <tbody>
          @for (vehicule of pagedVehicules(); track vehicule.id ?? $index) {
            <tr>
              <td>{{ vehicule.marque }}</td>
              <td>{{ vehicule.modele }}</td>
              <td class="immat">{{ vehicule.immatriculation }}</td>
              <td>{{ vehicule.nbPlaces }}</td>
              <td>{{ vehicule.co2ParKm }}</td>
              <td>{{ vehicule.motorisation }}</td>

              <td class="photo-cell">
                <img
                  class="thumb"
                  [src]="vehicule.photo || 'https://placehold.co/72x48?text=Photo'"
                  alt="Photo v√©hicule"
                  loading="lazy"
                />
              </td>

              <td class="actions-col">
                <div class="actions-cell">
                  @if (vehicule.id != null) {
                    <button 
                      type="button" 
                      class="action-btn" 
                      title="Voir les r√©servations" 
                      (click)="openInformation(vehicule)"
                      aria-label="Voir les r√©servations du v√©hicule">
                      ‚ÑπÔ∏è
                    </button>

                    <button
                      type="button"
                      class="action-btn edit-btn"
                      title="Modifier"
                      (click)="openEdit(vehicule)"
                      aria-label="Modifier le v√©hicule"
                    >
                      <i class="icon-edit">‚úèÔ∏è</i>
                    </button>

                    <button
                      type="button"
                      class="action-btn delete-btn"
                      title="Supprimer"
                      (click)="openModale(vehicule)"
                      aria-label="Supprimer le v√©hicule"
                    >
                      <i class="icon-delete">üóëÔ∏è</i>
                    </button>
                  }
                </div>
              </td>

              <td>
                <span
                  class="badge"
                  [class.badge--ok]="vehicule.statut === 'EN_SERVICE'"
                  [class.badge--warn]="vehicule.statut === 'EN_REPARATION'"
                  [class.badge--off]="vehicule.statut === 'HORS_SERVICE'"
                >
                  {{ (vehicule.statut ?? 'INCONNU').replace('_',' ').toLowerCase() | titlecase }}
                </span>
              </td>
            </tr>
          }

          @if (filtered().length === 0) {
            <tr>
              <td colspan="9" class="empty">Aucun v√©hicule pour ce filtre.</td>
            </tr>
          }
        </tbody>
      </table>

      <!-- ========== Pagination ========== -->
      <div class="pagination">
        <button
          type="button"
          class="pager"
          (click)="prevPage()"
          [disabled]="page() === 1"
        >
          Pr√©c√©dent
        </button>

        <span class="pager__info">
          Page {{ page() }} / {{ totalPages() }}
        </span>

        <button
          type="button"
          class="pager"
          (click)="nextPage()"
          [disabled]="page() === totalPages()"
        >
          Suivant
        </button>
      </div>
    </div>
  </section>

  <!-- =========================================================
       CTA principal
     ========================================================= -->
  <div class="cta">
    <button type="button" class="btn-primary" (click)="openCreate()">
      ENREGISTRER UN NOUVEAU V√âHICULE
    </button>
  </div>
</div>

<!-- =========================================================
     Modales
     ========================================================= -->
@if (vehiculeToEdit(); as editing) {
  <app-vehicule-edit
    [open]="!!vehiculeToEdit()"
    [model]="editing"
    [title]="modaleTitle()"
    [showStatut]="true"
    (confirm)="onSaveEdit($event)"
    (cancel)="closeEdit()"
  ></app-vehicule-edit>
}

@if (creationVehicule()) {
  <app-vehicule-edit
    [open]="!!creationVehicule()"
    [title]="modaleTitle()"
    [showStatut]="true"
    (confirm)="onSaveEdit($event)"
    (cancel)="closeEdit()"
  ></app-vehicule-edit>
}

@if(vehiculeReservations()) {
  <app-reservations-modale
    [open]="!!vehiculeReservations()"
    [title]="'R√©servations du v√©hicule ' + (selectedVehicule()?.immatriculation ?? '')"
    [reservations]="vehiculeReservations() ?? []"
    (close)="closeModale()"
  ></app-reservations-modale>
}

<!-- Modale suppression impossible -->
<app-information-modale
  [open]="cantDeleteInfoOpen()"
  [title]="cantDeleteInfoTitle()"
  [message]="cantDeleteInfoMessage()"
  closeLabel="Fermer"
  (close)="closeInfoModale()">
</app-information-modale>

<app-confirm-dialog
  [open]="!!vehiculeToDelete()"
  [title]="modaleTitle()"
  [message]="modaleContent()"
  confirmLabel="Supprimer"
  cancelLabel="Annuler"
  (confirm)="confirmModale()"
  (cancel)="closeModale()"
></app-confirm-dialog>

<app-footer></app-footer>
